'use strict';

const fs = require('fs');
const path = require('path');
const processData = require('./process-data');

function rank(entries) {
  entries.forEach(entry => entry.weight = entry.sizes.compressed);
  return entries;
}

/**
 * Given the path with *.out.json files (generated by `summarize`/`summarize.all`), create the object containing all the
 * meta data required for foamtree.js
 *
 * @param statsPath
 * @returns {{groups}}
 */
module.exports = function outputSummary(statsPath) {
  let entries = fs.readdirSync(statsPath)
    .filter(file => /\.out\.json$/.test(file))
    .map(file => JSON.parse(fs.readFileSync(path.join(statsPath, file), 'UTF8')))
    .filter(json => json.files && json.files.length > 0)
    .map(processData);

  return {
    groups: rank(entries)
  };
};
